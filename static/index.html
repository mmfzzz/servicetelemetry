<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è¿œç¨‹æœåŠ¡ç›‘æ§å¤§å±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: #12121e;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4fc3f7;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
        }

        .panel {
            background-color: #1e1e2f;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .panel-title {
            color: #81d4fa;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 500;
            border-bottom: 1px solid #3d3d5c;
            padding-bottom: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        textarea, input {
            width: 100%;
            padding: 12px 16px;
            background-color: #2d2d44;
            border: 1px solid #3d3d5c;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: #4fc3f7;
        }

        .btn {
            background-color: #4fc3f7;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background-color: #29b6f6;
        }

        .btn-secondary {
            background-color: #3d5a80;
        }

        .btn-secondary:hover {
            background-color: #4a6fa5;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }

        .result-table th, .result-table td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid #2d2d44;
            word-wrap: break-word;
        }

        .result-table th {
            background-color: #2d2d44;
            color: #81d4fa;
            font-weight: 500;
        }

        .result-table th:nth-child(1),
        .result-table td:nth-child(1) {
            width: 30%;
            min-width: 200px;
        }

        .status-success {
            color: #66bb6a;
            font-weight: 500;
        }

        .status-failed {
            color: #ef5350;
            font-weight: 500;
        }

        .keyword-match {
            color: #66bb6a;
        }

        .keyword-mismatch {
            color: #ef5350;
        }

        .empty-row td {
            padding: 40px 0;
            text-align: center;
            color: #81d4fa;
        }

        /* é€šç”¨é—®ç­”ç»“æœæ ·å¼ä¼˜åŒ– */
        .chat-reply {
            line-height: 1.8;
            padding: 20px;
            color: #e0e0e0;
            white-space: pre-wrap;
            font-size: 14px;
        }

        .reply-tag {
            color: #4fc3f7;
            font-weight: 500;
            margin-bottom: 10px;
            margin-top: 10px;
        }

        .hint-text {
            font-size: 12px;
            color: #90a4ae;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>è¿œç¨‹æœåŠ¡ç›‘æ§å¤§å±</h1>

    <!-- æœåŠ¡ç›‘æ§é…ç½® -->
    <div class="panel">
        <div class="panel-title">æœåŠ¡ç›‘æ§é…ç½®</div>
        <div class="form-group">
                <textarea id="targets-input" placeholder="è¯·è¾“å…¥ç›‘æ§ç›®æ ‡ï¼Œæ¯è¡Œä¸€ä¸ªï¼ˆæ”¯æŒHTTP/HTTPS/TCPï¼‰ï¼š
ç¤ºä¾‹ï¼š
https://www.github.com
https://www.douban.com
tcp://127.0.0.1:8080"></textarea>
        </div>
        <div class="form-group">
            <input type="text" id="keyword-input" placeholder="è¯·è¾“å…¥å“åº”ä½“åŒ¹é…å…³é”®è¯ï¼ˆå¯é€‰ï¼‰">
        </div>
        <button class="btn" onclick="submitTargets()">å¼€å§‹ç›‘æ§</button>
        <div class="hint-text">æç¤ºï¼šç›‘æ§ç»“æœä¼šè‡ªåŠ¨å­˜å…¥æ•°æ®åº“ï¼Œç”¨äºåç»­å†å²æŸ¥è¯¢å’ŒAIæ€»ç»“</div>

        <div class="result-area">
            <table class="result-table">
                <thead>
                <tr>
                    <th>ç›®æ ‡åœ°å€</th>
                    <th>çŠ¶æ€</th>
                    <th>çŠ¶æ€ç </th>
                    <th>å“åº”è€—æ—¶ï¼ˆmsï¼‰</th>
                    <th>SSLè¯ä¹¦</th>
                    <th>å…³é”®è¯åŒ¹é…</th>
                    <th>é”™è¯¯ä¿¡æ¯</th>
                </tr>
                </thead>
                <tbody id="result-table-body">
                <tr class="empty-row">
                    <td colspan="7">æš‚æ— ç›‘æ§æ•°æ®</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- å†å²ç›‘æ§æ•°æ® -->
    <div class="panel">
        <div class="panel-title">å†å²ç›‘æ§æ•°æ®</div>
        <div class="form-group" style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
            <input type="text" id="history-targetUrl" placeholder="ç›®æ ‡åœ°å€ï¼ˆå¯é€‰ï¼‰" style="min-height: auto; flex: 1; min-width: 200px;">
            <input type="datetime-local" id="history-startTime" style="min-height: auto; width: 200px;">
            <input type="datetime-local" id="history-endTime" style="min-height: auto; width: 200px;">
            <button class="btn" onclick="getHistoryResults()">æŸ¥è¯¢å†å²æ•°æ®</button>
            <!-- æ–°å¢ï¼šæ¸…ç©ºå†å²æ•°æ®æŒ‰é’® -->
            <button class="btn btn-danger" onclick="clearHistoryResults()">æ¸…ç©ºå†å²æ•°æ®å±•ç¤º</button>
        </div>
        <div class="hint-text">æç¤ºï¼šä¸å¡«å†™æ—¶é—´é»˜è®¤æŸ¥è¯¢è¿‘24å°æ—¶æ•°æ®ï¼›æ¸…ç©ºä»…éšè—é¡µé¢å±•ç¤ºï¼Œä¸åˆ é™¤æ•°æ®åº“ä¸­çš„æ•°æ®</div>

        <div class="result-area">
            <table class="result-table">
                <thead>
                <tr>
                    <th>ç›®æ ‡åœ°å€</th>
                    <th>çŠ¶æ€</th>
                    <th>çŠ¶æ€ç </th>
                    <th>å“åº”è€—æ—¶ï¼ˆmsï¼‰</th>
                    <th>SSLè¯ä¹¦</th>
                    <th>æ£€æŸ¥æ—¶é—´</th>
                </tr>
                </thead>
                <tbody id="history-result-table-body">
                <tr class="empty-row">
                    <td colspan="6">æš‚æ— å†å²æ•°æ®</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- å°åŠ©æ‰‹ï¼ˆæ”¯æŒé€šç”¨é—®ç­”ï¼‰ -->
    <div class="panel">
        <div class="panel-title">å°åŠ©æ‰‹</div>
        <div class="form-group">
                <textarea id="agent-query-input" placeholder="å°åŠ©æ‰‹ä½¿ç”¨è¯´æ˜ï¼š
1.  ç›‘æ§æ€»ç»“ï¼šç›´æ¥è¾“å…¥ç›‘æ§ç›¸å…³é—®é¢˜ï¼Œç‚¹å‡»ã€ç›‘æ§æ€»ç»“ï¼ˆAIï¼‰ã€‘
   ç¤ºä¾‹ï¼šè¿‘24å°æ—¶å“ªäº›æœåŠ¡å¼‚å¸¸ï¼Ÿæ€»ç»“ä»Šå¤©çš„ç›‘æ§æƒ…å†µ
2.  é€šç”¨é—®ç­”ï¼šç›´æ¥è¾“å…¥ä»»æ„é—®é¢˜ï¼Œç‚¹å‡»ã€é€šç”¨é—®ç­”ï¼ˆAIï¼‰ã€‘
   ç¤ºä¾‹ï¼šä»€ä¹ˆæ˜¯HTTP 502ï¼ŸGoåç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«ï¼Ÿå¦‚ä½•æ’æŸ¥TCPè¿æ¥å¤±è´¥ï¼Ÿ" style="min-height: 120px;"></textarea>
        </div>
        <button class="btn" onclick="agentQuery('data')">çº¯æ•°æ®å±•ç¤º</button>
        <button class="btn" onclick="agentQuery('ai')">ç›‘æ§æ€»ç»“ï¼ˆAIï¼‰</button>
        <button class="btn btn-secondary" onclick="generalChat()">é€šç”¨é—®ç­”ï¼ˆAIï¼‰</button>

        <div class="result-area" style="margin-top: 20px; padding: 16px; background-color: #2d2d44; border-radius: 4px; min-height: 100px;" id="agent-result">
            <div style="text-align: center; color: #81d4fa; padding: 20px 0;">æŸ¥è¯¢ç»“æœå°†å±•ç¤ºåœ¨è¿™é‡Œ</div>
        </div>
    </div>
</div>

<script>
    // æäº¤ç›‘æ§ç›®æ ‡
    function submitTargets() {
        const targetsInput = document.getElementById('targets-input');
        const keywordInput = document.getElementById('keyword-input');
        const tableBody = document.getElementById('result-table-body');

        const targets = targetsInput.value.trim().split('\n').filter(item => item.trim() !== '');
        if (targets.length === 0) {
            alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªç›‘æ§ç›®æ ‡ï¼');
            return;
        }

        tableBody.innerHTML = '<tr class="empty-row"><td colspan="7">æ­£åœ¨æ£€æŸ¥ï¼Œè¯·ç¨å€™...</td></tr>';

        fetch('/api/targets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                targets: targets,
                keyword: keywordInput.value.trim()
            })
        }).then(res => res.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    let html = '';
                    data.results.forEach(item => {
                        const statusClass = item.status === 'success' ? 'status-success' : 'status-failed';
                        const statusText = item.status === 'success' ? 'æ­£å¸¸' : 'å¼‚å¸¸';
                        const keywordClass = item.keywordMatched ? 'keyword-match' : 'keyword-mismatch';
                        const keywordText = item.keywordMatched ? 'âœ…' : 'âŒ';

                        html += `
                          <tr>
                              <td>${item.targetUrl}</td>
                              <td class="${statusClass}">${statusText}</td>
                              <td>${item.statusCode}</td>
                              <td>${item.responseTime.toFixed(2)}</td>
                              <td>${item.sslCertExpiry || '-'}</td>
                              <td class="${keywordClass}">${keywordText}</td>
                              <td class="${statusClass}">${item.errorMsg || '-'}</td>
                          </tr>
                          `;
                    });
                    tableBody.innerHTML = html;
                } else {
                    tableBody.innerHTML = '<tr class="empty-row"><td colspan="7">æš‚æ— ç›‘æ§æ•°æ®</td></tr>';
                }
            })
            .catch(err => {
                console.error('ç›‘æ§å¤±è´¥ï¼š', err);
                tableBody.innerHTML = '<tr class="empty-row"><td colspan="7" style="color: #ef5350;">ç›‘æ§å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡</td></tr>';
            });
    }

    // æŸ¥è¯¢å†å²æ•°æ®
    function getHistoryResults() {
        const targetUrl = document.getElementById('history-targetUrl').value;
        const startTime = document.getElementById('history-startTime').value;
        const endTime = document.getElementById('history-endTime').value;
        const tableBody = document.getElementById('history-result-table-body');

        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            return timeStr.replace('T', ' ') + ':00';
        };

        tableBody.innerHTML = '<tr class="empty-row"><td colspan="6">æ­£åœ¨æŸ¥è¯¢ï¼Œè¯·ç¨å€™...</td></tr>';

        fetch(`/api/history/results?targetUrl=${encodeURIComponent(targetUrl)}&startTime=${encodeURIComponent(formatTime(startTime))}&endTime=${encodeURIComponent(formatTime(endTime))}`)
            .then(res => {
                if (!res.ok) throw new Error(`æ¥å£è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${res.status}`);
                return res.json();
            })
            .then(data => {
                if (data.list && data.list.length > 0) {
                    let html = '';
                    data.list.forEach(item => {
                        const statusClass = item.status === 'success' ? 'status-success' : 'status-failed';
                        const statusText = item.status === 'success' ? 'æ­£å¸¸' : 'å¼‚å¸¸';
                        const checkedAt = new Date(item.checkedAt).toLocaleString();

                        html += `
                            <tr>
                                <td>${item.targetUrl}</td>
                                <td class="${statusClass}">${statusText}</td>
                                <td>${item.statusCode}</td>
                                <td>${item.responseTime.toFixed(2)}</td>
                                <td>${item.sslCertExpiry || '-'}</td>
                                <td>${checkedAt}</td>
                            </tr>
                            `;
                    });
                    tableBody.innerHTML = html;
                } else {
                    tableBody.innerHTML = '<tr class="empty-row"><td colspan="6">æš‚æ— å†å²æ•°æ®</td></tr>';
                }
            })
            .catch(err => {
                console.error('æŸ¥è¯¢å†å²æ•°æ®å¤±è´¥ï¼š', err);
                tableBody.innerHTML = '<tr class="empty-row"><td colspan="6" style="color: #ef5350;">æŸ¥è¯¢å¤±è´¥ï¼š' + err.message + '</td></tr>';
            });
    }

    // æ–°å¢ï¼šæ¸…ç©ºå†å²æ•°æ®å±•ç¤ºï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    function clearHistoryResults() {
        const historyTableBody = document.getElementById('history-result-table-body');
        // æ¢å¤åˆå§‹çŠ¶æ€ï¼šæ˜¾ç¤ºã€Œæš‚æ— å†å²æ•°æ®ã€
        historyTableBody.innerHTML = '<tr class="empty-row"><td colspan="6">æš‚æ— å†å²æ•°æ®</td></tr>';

        // å¯é€‰ï¼šæ¸…ç©ºæŸ¥è¯¢æ¡ä»¶è¾“å…¥æ¡†ï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰
        document.getElementById('history-targetUrl').value = '';
        document.getElementById('history-startTime').value = '';
        document.getElementById('history-endTime').value = '';
    }

    // å°åŠ©æ‰‹æŸ¥è¯¢ï¼ˆçº¯æ•°æ®/ç›‘æ§æ€»ç»“ï¼‰
    function agentQuery(mode) {
        const queryInput = document.getElementById('agent-query-input');
        const agentResult = document.getElementById('agent-result');
        const userQuery = queryInput.value.trim();

        if (userQuery === '') {
            alert('è¯·è¾“å…¥å…·ä½“çš„æŸ¥è¯¢å†…å®¹ï¼');
            return;
        }

        // åŠ è½½ä¸­æç¤º
        agentResult.innerHTML = '<div style="text-align: center; color: #81d4fa; padding: 20px 0;">æ­£åœ¨æŸ¥è¯¢ï¼Œè¯·ç¨å€™...</div>';

        // å‘é€è¯·æ±‚
        fetch('/api/agent/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userQuery: userQuery,
                mode: mode
            })
        }).then(res => res.json())
            .then(data => {
                if (data.isSuccess) {
                    // æ¨¡å¼1ï¼šdata - çº¯æ•°æ®å±•ç¤ºï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
                    if (mode === 'data') {
                        if (data.data && data.data.length > 0) {
                            let html = '<table class="result-table" style="width: 100%;">';
                            html += `
                              <thead>
                                  <tr>
                                      <th>ç›®æ ‡åœ°å€</th>
                                      <th>çŠ¶æ€</th>
                                      <th>å“åº”è€—æ—¶ï¼ˆmsï¼‰</th>
                                      <th>SSLè¯ä¹¦</th>
                                      <th>é”™è¯¯ä¿¡æ¯</th>
                                  </tr>
                              </thead>
                              <tbody>
                              `;
                            data.data.forEach(item => {
                                const statusClass = item.status === 'success' ? 'status-success' : 'status-failed';
                                const statusText = item.status === 'success' ? 'æ­£å¸¸' : 'å¼‚å¸¸';

                                html += `
                                  <tr>
                                      <td>${item.targetUrl}</td>
                                      <td class="${statusClass}">${statusText}</td>
                                      <td>${item.responseTime.toFixed(2)}</td>
                                      <td>${item.sslCertExpiry || '-'}</td>
                                      <td class="${statusClass}">${item.errorMsg || '-'}</td>
                                  </tr>
                                  `;
                            });
                            html += `</tbody></table>`;
                            agentResult.innerHTML = html;
                        } else {
                            agentResult.innerHTML = '<div class="chat-reply" style="text-align: center;">æœªæŸ¥è¯¢åˆ°ç›¸å…³ç›‘æ§æ•°æ®</div>';
                        }
                    }

                    // æ¨¡å¼2ï¼šai - ç›‘æ§æ€»ç»“ï¼ˆæ–‡æœ¬å½¢å¼ï¼‰
                    if (mode === 'ai') {
                        const tag = data.isMonitorSummary ? 'ğŸ“Š ç›‘æ§æ•°æ®æ€»ç»“' : 'ğŸ’¡ æç¤ºä¿¡æ¯';
                        agentResult.innerHTML = `
                          <div class="reply-tag">${tag}</div>
                          <div class="chat-reply">${data.reply}</div>
                          `;
                    }
                } else {
                    agentResult.innerHTML = `<div class="chat-reply" style="color: #ef5350; text-align: center;">æŸ¥è¯¢å¤±è´¥ï¼š${data.errorMsg}</div>`;
                }
            })
            .catch(err => {
                console.error('å°åŠ©æ‰‹æŸ¥è¯¢å¤±è´¥ï¼š', err);
                agentResult.innerHTML = '<div class="chat-reply" style="color: #ef5350; text-align: center;">æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡</div>';
            });
    }

    // ç‹¬ç«‹é€šç”¨é—®ç­”å‡½æ•°ï¼ˆç¡®ä¿æ·»åŠ /chatå‰ç¼€ï¼‰
    function generalChat() {
        const queryInput = document.getElementById('agent-query-input');
        const agentResult = document.getElementById('agent-result');
        const userQuery = queryInput.value.trim();

        if (userQuery === '') {
            alert('è¯·è¾“å…¥å…·ä½“çš„é—®é¢˜ï¼');
            return;
        }

        // å¼ºåˆ¶æ·»åŠ /chatå‰ç¼€ï¼ˆå…³é”®ä¿®å¤ï¼‰
        const finalQuery = '/chat ' + userQuery;
        console.log('é€šç”¨é—®ç­”æœ€ç»ˆè¯·æ±‚ï¼š', finalQuery); // è°ƒè¯•æ—¥å¿—ï¼Œå¯åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹

        // åŠ è½½ä¸­æç¤º
        agentResult.innerHTML = '<div style="text-align: center; color: #81d4fa; padding: 20px 0;">æ­£åœ¨æ€è€ƒï¼Œè¯·ç¨å€™...</div>';

        // å‘é€è¯·æ±‚ï¼ˆä½¿ç”¨finalQueryï¼Œç¡®ä¿å¸¦å‰ç¼€ï¼‰
        fetch('/api/agent/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userQuery: finalQuery, // ç¡®ä¿ä¼ é€’çš„æ˜¯å¸¦/chatå‰ç¼€çš„é—®é¢˜
                mode: 'ai'
            })
        }).then(res => res.json())
            .then(data => {
                if (data.isSuccess) {
                    agentResult.innerHTML = `
                      <div class="reply-tag">ğŸ¤– å°åŠ©æ‰‹å›ç­”</div>
                      <div class="chat-reply">${data.reply}</div>
                      `;
                } else {
                    agentResult.innerHTML = `<div class="chat-reply" style="color: #ef5350; text-align: center;">æŸ¥è¯¢å¤±è´¥ï¼š${data.errorMsg}</div>`;
                }
            })
            .catch(err => {
                console.error('é€šç”¨é—®ç­”å¤±è´¥ï¼š', err);
                agentResult.innerHTML = '<div class="chat-reply" style="color: #ef5350; text-align: center;">æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡</div>';
            });
    }
</script>
</body>
</html>